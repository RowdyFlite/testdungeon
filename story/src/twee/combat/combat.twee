:: Combat
<<set _player=$combat.combatants["player"]>>\

<<include "CombatLog">>

<<run $combat.tick()>>\

<<if !$combat.finished>>
	<<include "CombatActions">>
<<else>>
	<<if $combat.won>>
		<<include "CombatWin">>
	<<else>>
		<<include "CombatLoss">>
	<</if>>
<</if>>

:: CombatLog
<<for _i, _log range $roundLog>>\
	<<print _log>>
<</for>>
<<set $roundLog=[]>>\

:: CombatWin
<<link "You won!" "Dungeon">>\
	<<set $dungeon.floors[$dungeon.current_floor].rooms[$dungeon.current_room].encounter = null>>
<</link>>
<<set _xp = 0>>\
<<for _i, _id range $combat.opponents>>\
	<<set _xp += $combat.getCombatant(_id).xp>>\
<</for>>
<<addXP _xp>>
<<endCombat>>\

:: CombatLoss
You have been defeated!

<<link "Lose" "Die">><</link>>

:: CombatActions
Your HP: _player.hp/_player.maxhp
Opponents:
	<<for _i, _id range $combat.opponents>>\
		<<set _enemy=$combat.getCombatant(_id)>>
		<<nobr>>
	  	<<capture _enemy>>\
	  		<<if _enemy.hp > 0>>\
		  		<<button "Attack">>\
		  			<<run $combat.attack("player", _enemy.id)>>
		  			<<include "EnemyAttacks">>
		  			<<goto "Combat">>
		  		<</button>>
		  		<<print "_enemy.tag HP: _enemy.hp/_enemy.maxhp">>
		  	<<else>>
		  		<<print "_enemy.tag Dead">>
	  		<</if>>
		<</capture>>
		<</nobr>>
	<</for>>
	<<button "Wait">>\
		<<include "EnemyAttacks">>
		<<goto "Combat">>
	<</button>>

:: EnemyAttacks
<<for _i, _id range $combat.opponents>>\
	<<set _enemy=$combat.getCombatant(_id)>>
	<<if _enemy.hp > 0>>
		<<run $combat.attack(_enemy.id, "player")>>
	<</if>>
<</for>>